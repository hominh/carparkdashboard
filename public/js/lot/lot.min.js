$("document").ready(function(){setTimeout(function(){location=""},12e5);var g,h,i=1,j=0,k=0,b=$("#drawingArea").innerWidth(),c=$("#drawingArea").innerHeight();setInterval(function(){1==j&&o()},1);var l=new Konva.Stage({container:"drawingArea",width:b,height:c}),m=new Konva.Layer,d=new Image;d.onload=function(){var a=new Konva.Image({image:d});m.add(a),a.moveToBottom(),l.add(m)};var a=$("#basement :selected").val();function n(){var b=m.find("Arrow"),c=m.find("Path");if(b.length>0)for(var a=0;a<b.length;a++)b[a].remove();if(c.length>0)for(var a=0;a<c.length;a++)c[a].remove();var d=m.find("Image");if(d.length>0)for(var a=0;a<d.length;a++)d[a].remove()}function e(d){n();var b=m.find("Rect");if(b.length>0)for(var a=0;a<b.length;a++)b[a].remove();var c=m.find("Text");if(c.length>0)for(var a=0;a<c.length;a++)c[a].remove();var e=new Image;e.onload=function(){var a=new Konva.Image({image:e});m.add(a),a.moveToBottom(),l.add(m)},$.ajax({url:"basement/getdatabyid",method:"POST",data:{"_token":$('meta[name="_token"]').attr("content"),basement:d},success:function(a){e.src=JSON.parse(a).image,$.each(JSON.parse(a).kiosk,function(h,a){var c=a.y2-a.y1,d=a.x2-a.x1,e=(parseInt(a.x2)+parseInt(a.x1))/2,f=(parseInt(a.y2)+parseInt(a.y1))/2,b=new Konva.Text({x:e,y:f,text:a.name,fontSize:20,fontFamily:"Arial",fill:"black"});b.offsetX(b.width()/2),b.offsetY(b.height()/2);var g=new Konva.Rect({x:a.x1,y:a.y1,width:d,height:c,fill:"cyan",stroke:"black",strokeWidth:1});m.add(g),m.add(b)})}})}function o(){var a=k-i;h.dashOffset(a),m.draw(),i+=3,a<=0&&(j=0,i=0,m.add(g))}function p(a,c){for(var b in a)a[b]==c&&a.splice(b,1)}function f(b){var a="status/initdata";a=a+"/"+b,$.ajax({method:"GET",url:a,success:function(a){$("#countblank").val(a.countEnableLot[0][""]),$.each(a,function(i,a){var c,d=a.y4_web-a.y1_web,e=a.x2_web-a.x1_web,f=(parseInt(a.x3_web)+parseInt(a.x1_web))/2,g=(parseInt(a.y3_web)+parseInt(a.y1_web))/2,b=new Konva.Text({x:f,y:g,text:a.plate,fontSize:20,fontFamily:"Arial",fill:"white"});b.offsetX(b.width()/2),b.offsetY(b.height()/2),1==a.status&&(c="red"),0==a.status&&(c="green"),2==a.status&&(c="yellow");var h=new Konva.Rect({x:a.x1_web,y:a.y1_web,width:e,height:d,fill:c,stroke:"black",strokeWidth:1});m.add(h),m.add(b)})}})}e(a),f(a),$("#basement").change(function(){var b=$(this).val();e(b),a=b,f(b)}),$("#plate").val(),$("#searchPlate2").select2({minimumInputLength:1,language:{inputTooShort:function(){return"Vui l\xf2ng nh\u1EADp bi\u1EC3n s\u1ED1 xe"}},ajax:{url:"status/getbyplate",dataType:"json",data:function(a){return{plate:a.term,page:a.page}},processResults:function(b,a){return a.page=a.page||1,{results:b,pagination:{more:30*a.page<b.total_count}}},cache:!0},templateResult:function(a){if(a.loading)return a.text;var b=$("<div class='select2-result-repository clearfix'><div class='select2-result-repository__meta'><div class='select2-result-repository__basement'></div></div></div></div>"),c=a.basement_name+"-"+a.kiosk_name+"-"+a.plate;return b.find(".select2-result-repository__basement").text(c),b},templateSelection:function(a){return a.basement_name+"-"+a.kiosk_name+"-"+a.plate}}),$("#searchPlate2").on("select2:select",function(a){n();var i=new Image;i.onload=function(){var a=new Konva.Image({image:i});m.add(a),a.moveToBottom(),l.add(m)},i.src=a.params.data.basement_image;var o=a.params.data.x1_path.substr(0,a.params.data.x1_path.length-1),q=a.params.data.y1_path.substr(0,a.params.data.y1_path.length-1);a.params.data.x2_path.substr(0,a.params.data.x2_path.length-1),a.params.data.y2_path.substr(0,a.params.data.y2_path.length-1);var b=o.split("-"),d=q.split("-");p(b,""),p(d,"");for(var f=b.length-1,e="",c=0;c<b.length;c++)0==c?(e+="M"+b[c],e+=" "+d[c]):(e+=" L"+b[c],e+=" "+d[c]);g=new Konva.Arrow({points:[b[f-2],d[f-2],b[f],d[f]],pointerLength:10,pointerWidth:10,fill:"red",stroke:"red",strokeWidth:1}),h=new Konva.Path({data:e,stroke:"red"}),k=h.getLength(),h.dashOffset(k),h.dash([k]),m.add(h),l.draw(),j=1}),setInterval(function(){var c,b;b=(b="status/getdata")+"/"+(c=a),$.ajax({method:"GET",url:b,success:function(a){$("#countblank").val(a.countEnableLot[0][""]),$.each(a,function(i,a){var c,d=a.y4_web-a.y1_web,e=a.x2_web-a.x1_web,f=(parseInt(a.x3_web)+parseInt(a.x1_web))/2,g=(parseInt(a.y3_web)+parseInt(a.y1_web))/2,b=new Konva.Text({x:f,y:g,text:a.plate,fontSize:20,fontFamily:"Arial",fill:"white"});b.offsetX(b.width()/2),b.offsetY(b.height()/2),1==a.status&&(c="red"),0==a.status&&(c="green"),2==a.status&&(c="yellow");var h=new Konva.Rect({x:a.x1_web,y:a.y1_web,width:e,height:d,fill:c,stroke:"black",strokeWidth:1});m.add(h),m.add(b)})}})},1e4),$("#drawingArea").click(function(a){var b=$(this).offset(),c=b.left,d=b.top,e=a.pageX-c,f=a.pageY-d;$.ajax({method:"POST",url:"lot/findLotByCoordinate",data:{"_token":$('meta[name="_token"]').attr("content"),x:e,y:f,basement:$("#basement :selected").val()},success:function(d){var a=$.parseJSON(d);if(1==a.length){var b=detailLotStatus=detailLotPlate=detailUpdated_at=detailLotOverlap="",c="data:image/png;base64,";c+=a[0].image,detailUpdated_at+=a[0].updated_at,detailLotOverlap+=a[0].overlap_calc,b=a[0].basment_name+" - "+a[0].lotname,$("#detailLotName").text(b),"1"==a[0].status&&(detailLotStatus="C\xf3 xe"),"0"==a[0].status&&(detailLotStatus="Kh\xf4ng c\xf3 xe"),"2"==a[0].status&&(detailLotStatus="Kh\u1EDFi t\u1EA1o"),detailLotStatus="Tr\u1EA1ng th\xe1i: "+detailLotStatus,detailLotPlate="Bi\u1EC3n s\u1ED1: "+a[0].plate,detailUpdated_at="C\u1EADp nh\u1EADt l\xfac: "+detailUpdated_at,detailLotOverlap="Overlap : "+detailLotOverlap,$("#detailLotStatus").text(detailLotStatus),$("#detailLotPlate").text(detailLotPlate),$("#myModal").modal("show"),$("#image_lot").attr("src",c),$("#detailLotUpdate").text(detailUpdated_at),$("#detailLotOverlap").text(detailLotOverlap)}}})})})
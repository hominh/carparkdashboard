$("document").ready(function(){var f=[],g=[],b=$("#drawingArea").innerWidth(),c=$("#drawingArea").innerHeight(),h=new Konva.Stage({container:"drawingArea",width:b,height:c}),i=new Konva.Layer,a=$("#basement :selected").val();function d(d){var b=i.find("Arrow");if(b.length>0)for(var a=0;a<b.length;a++)b[a].remove();var c=i.find("Path");if(c.length>0)for(var a=0;a<c.length;a++)c[a].remove();url3=url3+"/"+d,$.ajax({url:url3,method:"GET",success:function(a){$.each(JSON.parse(a),function(e,d){var a=arr_x2_path_saved=arr_y1_path_saved=arr_y2_path_saved=[];a=d.x1_path.substr(0,d.x1_path.length-1).split("-"),arr_y1_path_saved=d.y1_path.substr(0,d.y1_path.length-1).split("-"),j(a,""),j(arr_y1_path_saved,""),a.length;for(var c="",b=0;b<a.length;b++)0==b?(c+="M"+a[b],c+=" "+arr_y1_path_saved[b]):(c+=" L"+a[b],c+=" "+arr_y1_path_saved[b]);arrow=new Konva.Arrow({points:[a[length],arr_y1_path_saved[length]],pointerLength:5,pointerWidth:5,fill:"red",stroke:"red",strokeWidth:1}),path=new Konva.Path({data:c,stroke:"red"}),i.draw(),i.add(path)})}})}function j(a,c){for(var b in a)a[b]==c&&a.splice(b,1)}function e(e){var b=i.find("Image");if(b.length>0)for(var a=0;a<b.length;a++)b[a].remove();var c=i.find("Rect");if(c.length>0)for(var a=0;a<c.length;a++)c[a].remove();var d=i.find("Text");if(d.length>0)for(var a=0;a<d.length;a++)d[a].remove();var f=new Image;f.onload=function(){var a=new Konva.Image({image:f});i.add(a),a.moveToBottom(),h.add(i)},$("#kiosk").find("option").remove(),$("#lot").find("option").remove(),$.ajax({url:url,method:"POST",data:{"_token":$('meta[name="_token"]').attr("content"),basement:e},success:function(a){f.src=JSON.parse(a).image,$.each(JSON.parse(a).kiosk,function(h,a){$("#kiosk").append($("<option></option>").attr("value",a.id).text(a.name));var c=a.y2-a.y1,d=a.x2-a.x1,e=(parseInt(a.x2)+parseInt(a.x1))/2,f=(parseInt(a.y2)+parseInt(a.y1))/2,b=new Konva.Text({x:e,y:f,text:a.name,fontSize:20,fontFamily:"Arial",fill:"black"});b.offsetX(b.width()/2),b.offsetY(b.height()/2);var g=new Konva.Rect({x:a.x1,y:a.y1,width:d,height:c,fill:"cyan",stroke:"black",strokeWidth:1});i.add(g),i.add(b)}),$.each(JSON.parse(a).lot,function(b,a){$("#lot").append($("<option></option>").attr("value",a.id).text(a.name))})}})}e(a),d(a),$("#basement").change(function(){var a=$(this).val();e(a),d(a)}),y1=null;var k,l,m,n,o=!1,p=[],q=0,r=!1;$("#drawingArea").on("mousedown",function(a){if($("#is_drawing").prop("checked")){var b=$(this).offset(),c=b.left,d=b.top,e=a.pageX,j=a.pageY;if(!1==r){n=h.getPointerPosition(),p.length>1&&p.splice(-2,2),p.push(n.x,n.y),f.push(e-c),g.push(j-d),k=new Konva.Line({points:p,name:"temp",fill:m,stroke:"black",strokeWidth:1,draggable:!1}),q=p.length,o=!0,i.add(k);var l=new Konva.Circle({x:n.x,y:n.y,radius:5,fill:"black",stroke:"black",strokeWidth:4});i.add(l)}}}),$("#drawingArea").on("dblclick",function(b){var a=new Konva.Line({points:p,name:"poly",fill:m,stroke:"black",strokeWidth:1,draggable:!0,closed:!1,hitStrokeWidth:10});i.add(a),i.draw(),r=!1,l="",q=0,o=!1,p=[]}),$("#drawingArea").mousemove(function(a){!1==r&& !0==o&&(n=h.getPointerPosition(),k.points()[q]=n.x,k.points()[q+1]=n.y,i.draw())}),$("#savepath").click(function(){for(var b="",c="",a=0;a<f.length;a++)b+=f[a]+"-",c+=g[a]+"-";var d=$("#lot option:selected").val(),e=$("#kiosk option:selected").val();url2+="/",url2+=d,url2+="/",url2+=e,$.ajax({url:url2,method:"POST",data:{"_token":$('meta[name="_token"]').attr("content"),lot_id:d,kiosk_id:e,x1_path:b,y1_path:c,x2_path:"0",y2_path:"0",success:function(a){toastr.success("C\u1EADp nh\u1EADt \u0111\u01B0\u1EDDng \u0111i th\xe0nh c\xf4ng")}}}),f.length=0,g.length=0})})